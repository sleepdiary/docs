#!/usr/bin/env node

const fs = require('fs');
const child_process = require('child_process');

const base_dir = __filename.replace(/[^\/]*$/,`..`);

const icons = {
    // make sure to synchronise this list with the one in docs/.../Map.vue
    physician : 'fa-user-doctor',
    researcher: 'fa-user-graduate',
};

function zero_pad(n,len) {
    n = n.toString();
    while ( n.length < (len||2) ) n = '0'+n;
    return n;
}

const edit_warning = `<!--

  DO NOT EDIT THIS FILE DIRECTLY

  See https://github.com/sleepdiary/docs/blob/main/bin/generate-from-resources.js

 -->`;

function nlbr(text) {
    return text.replace(/\n/g,'<br/>');
}

function generate(resources) {

    resources = JSON.parse(resources);

    /*
     * specialists/README.md
     */

    let markers = [];

    let specialists_md = `${edit_warning}

<Map style="margin-top:1em" :markers="markers"/>

## Specialists
`;

    resources.specialists.records
        .map( specialist => {

            specialist.locations.forEach( location => {
                const href = '#'+specialist.name.toLowerCase().replace(/[^\w]+/g,'-').replace(/^-*|-*$/g,'');
                const type_icon = 'fas '+icons[specialist.specialist_type];
                const type_text = specialist.specialist_type.charAt(0).toUpperCase() + specialist.specialist_type.substr(1);
                const is_direct = location.referral_type[0] == 'direct';
                const contact_icon = is_direct ? 'fas fa-circle' : 'fas fa-square';
                const contact_text = is_direct ? 'Can be contacted directly' : 'Must be referred by another specialist';
                const location_name = (
                    location.name
                        ? specialist.name + ': ' + location.name
                        : specialist.name
                );
                const location_text =
                      (
                          location.name
                              ? '<em>'+nlbr(location.name)+'</em><br/>'
                              :''
                      ) + nlbr(location.address)
                ;
                markers.push({
                    z_index_offset: is_direct ? 1000 : 0,
                    location: location.gps_coordinates,
                    icon: specialist.specialist_type,
                    shape: is_direct ? 'circle' : 'square',
                    tooltip: location_name,
                    popup:
                    `<div class="specialist-popup">` +
                      `<div class="specialist-popup-header">${specialist.name}</div>` +
                      `<div class="specialist-popup-key fas fa-location-dot"></div>` +
                      `<div class="specialist-popup-value">${location_text}</div>` +
                      `<div class="specialist-popup-key ${contact_icon}"></div>` +
                      `<div class="specialist-popup-value">${contact_text}</div>` +
                      `<div class="specialist-popup-key ${type_icon}"></div>` +
                      `<div class="specialist-popup-value">${type_text}</div>` +
                      `<a class="specialist-popup-footer" href="${href}">Learn more</a>` +
                    `</div>`
                })
            });

            const locations
                  = specialist.locations
                  .map(
                      location =>
                      `<div class="specialist-location">` +
                        `<div class="specialist-location-key fas fa-location-dot"></div>` +
                        `<div>` +
                          (location.name?'<em>'+location.name+'</em><br/>':'') +
                          nlbr(location.address) +
                        `</div>` +
                        (
                          location.url
                          ?
                            `<div class="specialist-location-key fas fa-link"></div>` +
                            `<a class="specialist-location-value" href="${location.url}" target="_blank" rel="noopener noreferrer">visit website<span><ExternalLinkIcon/><span class="external-link-icon-sr-only">open in new window</span></span></a>`
                          : ''
                        ) +
                        (
                          location.map_url
                          ?
                            `<div class="specialist-location-key fas fa-map"></div>` +
                            `<a class="specialist-location-value" href="${location.map_url}" target="_blank" rel="noopener noreferrer">view map<span><ExternalLinkIcon/><span class="external-link-icon-sr-only">open in new window</span></span></a>`
                          : ''
                        ) +
                      `</div>`
                  );

            specialists_md += [

                `
### ${specialist.name}\n\n`,

                (specialist.forms||[])
                    .map( item =>
                        `<ImageFrame :classes="['reactive']" link="${item.url}" base="" thumb="/..${item.thumb}">
  ${nlbr(item.name?item.short_name:'You may be asked<br>to fill out this form')}
</ImageFrame>

`).join(''),
                (specialist.reports||[])
                    .map( item =>
                        `<ImageFrame :classes="['reactive']" link="${item.url}" base="" thumb="/..${item.thumb}">
  ${nlbr(item.name?item.short_name:'You may be shown this report')}
</ImageFrame>

`).join(''),

                specialist.description,

                `

<ShowOnClick>

<template v-slot:header>

#### Location${ ( locations.length == 1 ) ? '' : 's' }

</template>

${locations.join('\n')}

</ShowOnClick>
`,

                specialist.procedure
                    ? `
<ShowOnClick>

<template v-slot:header>

#### Procedure

</template>
` : '',

                ( specialist.procedure_type == 'researched' )
                    ? `
::: tip
This is a summary of the procedure on their site.  [Let us know](https://github.com/sleepdiary/resources/issues/new?template=procedure-feedback.md&title=Feedback+about+the+procedure+for+${encodeURIComponent(specialist.name)}) how things work in reality!
:::
` : '',

                `
${specialist.procedure}
</ShowOnClick>
`
            ].join('');

            specialists_md += `
<div class="page-meta" style="clear:both;padding: 0 1em">

[Provide&nbsp;feedback&nbsp;about&nbsp;this&nbsp;specialist](https://github.com/sleepdiary/resources/issues/new?template=entity-feedback.md&title=Feedback+for+${encodeURIComponent(specialist.name)}) <EntryUpdated date="${specialist.last_updated.value}"/>

</div>
`;

        });

    specialists_md += `

## Add a new specialist

<ImageFrame :classes="['reactive']" link="https://github.com/sleepdiary/resources/issues/new?assignees=&labels=entities%2Ctriage&template=new-specialist.yaml&title=%5BNew+specialist%5D%3A+" thumb="/specialists/add.png">
  You may be asked<br>to fill out this form
</ImageFrame>

If you're a sleep specialist, or have visited one, please [tell us about it](https://github.com/sleepdiary/resources/issues/new?assignees=&labels=entities%2Ctriage&template=new-specialist.yaml&title=%5BNew+specialist%5D%3A+)!

<ShowOnClick>

<template v-slot:header>

#### Procedure

</template>

1. optionally [preview the &ldquo;new specialist&rdquo; form](https://github.com/sleepdiary/resources/blob/main/.github/ISSUE_TEMPLATE/new-specialist.yaml)
2. [create a GitHub account](https://github.com/signup) (if you don't already have one)
3. [fill out the &ldquo;new specialist&rdquo; form](https://github.com/sleepdiary/resources/issues/new?assignees=&labels=entities%2Ctriage&template=new-specialist.yaml&title=%5BNew+specialist%5D%3A+)
4. we'll discuss everything through that page
5. you can review proposed updates before publishing
6. we will aim to add a new section to this page

</ShowOnClick>

<style>
.specialist-popup,
.specialist-location {
  display: grid;
  grid-template-columns: 2em 1fr;
  grid-template-rows: repeat(3, min-content);
}
.specialist-popup {
  width:300px;
  max-width:50vw;
}
.specialist-location {
  margin-bottom: 2em;
}
.specialist-popup-header {
  grid-column-start: 1;
  grid-column-end: 3;
  padding: 1em 0;
  font-weight: bold;
  text-align: center;
}
.specialist-popup-key,
.specialist-location-key {
  grid-column: 1;
  margin-top: 1px;
  font-size: 1em;
  text-align: center;
}
.specialist-location-key {
  margin-top: 4px;
}
.specialist-popup-value,
.specialist-location-value {
  grid-column: 2;
}
.specialist-popup-footer {
  grid-column-start: 1;
  grid-column-end: 3;
  display: block;
  text-align: center;
  padding-top: 1em
}

</style>

<script>
export default {
  data() {
    return {
      markers: ${JSON.stringify(markers)},
    };
  },
}
</script>
`;

    /*
     * specialists/software.md
     */

        let software_md = `# Software

${edit_warning}

Here are some programs to help you track your sleep.  The galleries below all represent the same data, taken from [our common sleep diaries](https://sleepdiary.github.io/resources/common_sleep_diaries/).

`;

    resources.software.records
        .forEach( source => {
            software_md += `## ${source.name}

<ImageFrame :classes="['reactive']" link="${source.url}" base="" thumb="/..${source.thumb}">
  ${source.name}
</ImageFrame>

${source.description}
`;
            if ( source.url ) {
                software_md += `<div><span class="software-key fas fa-link"></span><a href="${source.url}">Home page</a></div>\n`;
            }
            if ( source.source_code ) {
                software_md += `<div><span class="software-key fas fa-code"></span><a href="${source.source_code}">Source code</a></div>\n`;
            }
            if ( source.file_format ) {
                software_md += `<div><span class="software-key fas fa-file-code"></span><a href="${source.file_format}">File format</a></div>\n`;
            }
            if ( source.business_model ) {
                software_md += `<div><span class="software-key fas fa-money-check-dollar"></span>${source.business_model}</div>\n`;
            }
            if ( source.platforms ) {
                const custom_platforms = {
                    website: 'fa-globe',
                    watch: 'fa-clock',
                    ios: 'fa-brands fa-apple',
                };
                software_md += (
                    `<div><span class="software-key fas fa-computer"></span>` +
                    source.platforms.map(
                        platform => `<span class="software-value fas ${custom_platforms[platform]||'fa-brands fa-'+platform}" title="${platform.charAt(0).toUpperCase()+platform.substr(1)}"></span>`
                    ).join('') +
                    `</div>\n`
                );
            }

            software_md += `
<ShowOnClick>

<template v-slot:header>

#### Procedure

</template>

${source.procedure}
</ShowOnClick>
`;

            if ( source.forms || source.reports ) {

                let images = [];
                ['forms','reports'].forEach( fr_key =>
                    (source[fr_key]||[]).forEach( fr =>
                        images = images.concat(fr.gallery||[])
                    )
                );

                software_md += `
<div style="clear:both"></div>

<ShowOnClick>

<template v-slot:header>

#### Gallery

</template>

<ImageGallery :images='${JSON.stringify(images)}'/>

</ShowOnClick>
`;

            }

            software_md += `
<div class="page-meta" style="clear:both;padding: 0 1em">

[Provide&nbsp;feedback&nbsp;about&nbsp;this&nbsp;software](https://github.com/sleepdiary/resources/issues/new?template=entity-feedback.md&title=Feedback+for+${encodeURIComponent(source.name)}) <EntryUpdated date="${source.last_updated.value}"/>

</div>

`;

        });

    software_md += `
## Add new software

<ImageFrame :classes="['reactive']" link="https://github.com/sleepdiary/resources/issues/new?assignees=&labels=entities%2Ctriage&template=new-software.yaml&title=%5BNew+software%5D%3A+" thumb="/create/add-software.png">
  You may be asked<br>to fill out this form
</ImageFrame>

If you know about another piece of software, please [tell us about it](https://github.com/sleepdiary/resources/issues/new?assignees=&labels=entities%2Ctriage&template=new-software.yaml&title=%5BNew+software%5D%3A+)!

<ShowOnClick>

<template v-slot:header>

#### Procedure

</template>

1. optionally [preview the &ldquo;new software&rdquo; form](https://github.com/sleepdiary/resources/blob/main/.github/ISSUE_TEMPLATE/new-software.yaml)
2. [create a GitHub account](https://github.com/signup) (if you don't already have one)
3. [fill out the &ldquo;new software&rdquo; form](https://github.com/sleepdiary/resources/issues/new?assignees=&labels=entities%2Ctriage&template=new-software.yaml&title=%5BNew+software%5D%3A+)
4. we'll discuss everything through that page
5. you can review proposed updates before publishing
6. we will aim to add a new section to this page

</ShowOnClick>

<style>
.software-key,
.software-value {
  display: inline-block;
  margin-top: 1px;
  font-size: 1em;
  text-align: center;
  width: 2em;
}
.software-value {
  width: 1.25em;
}
</style>
`


    /*
     * specialists/forms.md
     */

    let rows = {
        forms: [],
        reports: [],
        events: []
    };

    [].concat(resources.specialists.records,resources.software.records)
        .forEach( source => {
            ['forms','reports'].forEach( fr_key =>
                (source[fr_key]||[]).forEach( fr => {
                    if ( fr.layout == "calendar" ) {
                        fr.Source = {
                            key: source.name_key,
                            value: `<a href="${fr.url}">${fr.display_name}</a>`
                        };
                        rows[fr_key].push(fr);
                        (fr.events||[]).forEach( event =>
                            rows.events.push({
                                Source: {
                                    key: source.name_key,
                                    value: `<a href="${fr.url}">${fr.display_name}</a>`
                                },
                                Event: event.key,
                                Description: event.value,
                            })
                        );
                    }
                })
            );
        });

    const forms_md = `# Forms and reports

${edit_warning}

Before you make a new form, you might like to take some inspiration from some that already exist.  Or see [the list of specialists](./) to see what your doctor is likely to ask for.

## Forms

A &ldquo;form&rdquo; is a document you fill out.  This section compares the durations and layouts for different forms.

<SortableTable :columns="forms_reports_columns" :rows="forms_rows" />

## Reports

A &ldquo;report&rdquo; is a document generated based on the information in a form.  This section compares the durations and layouts for different reports.

<SortableTable :columns="forms_reports_columns" :rows="reports_rows" />

## Events

An &ldquo;event&rdquo; is anything that happens during a day, which someone might think is relevant to your sleep.  Diaries can ask people to fill out different events, and can use different symbols to represent them.  The table below summarises all known events.

<SortableTable :columns="events_columns" :rows="events_rows" />

<script>
export default {
  data() {
    return {
      forms_reports_columns: [
        { key: 'Source'         , value: 'Source' },
        { key: 'page_duration'  , value: 'page duration' },
        { key: 'total_pages'    , value: 'total pages' },
        { key: 'start_time'     , value: 'start time' },
        { key: 'inbed_marker'   , value: 'in-bed marker' },
        { key: 'outofbed_marker', value: 'out-of-bed marker' },
        { key: 'sleep_marker'   , value: 'sleep marker' },
      ],
      events_columns: [
        { key: 'Source'     , value: 'Source' },
        { key: 'Event'      , value: 'Event' },
        { key: 'Description', value: 'Description' },
      ],
      forms_rows: ${JSON.stringify(rows.forms)},
      reports_rows: ${JSON.stringify(rows.reports)},
      events_rows: ${JSON.stringify(rows.events)},
    };
  },
};
</script>
`;

    /*
     * Write files once everything else has succeeded
     */

    fs.writeFileSync('specialists/README.md', specialists_md);
    fs.writeFileSync('create/software.md', software_md);
    fs.writeFileSync('create/forms.md', forms_md);

}

if ( fs.existsSync(`${base_dir}/../resources/Makefile`) ) {
    child_process.execFileSync(`make`,[`-C`,`${base_dir}/../resources/`]);
    generate(fs.readFileSync(`${base_dir}/../resources/entities.json`));
} else {
    const https = require('https');
    https.get(
        'https://raw.githubusercontent.com/sleepdiary/resources/built/entities.json',
        res => {
            let json = '';
            res.on('data', data => json += data);
            res.on('end' , () => generate(json));
        }
    );
}
